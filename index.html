<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/1.2.8/tf.js"></script>
    <script src="yolo.js"></script>
</head>
<body>
    <h1>Test on webcam!!!</h1>
    <div id="screenshot">
        <!--style="text-align:center;"-->
        <button id="capture-video" onclick="initCameraStream();">Capture Webcam Video</button><br />
        <video id="streamvideo" class="videostream" autoplay playsinline></video><br /> <!--style="visibility:hidden;height:0px;width:0px;"-->
        <button id="capture-button">Take a picture</button> highalpha=<input id="highalpha" value="0.3" style="width:50px;" /> ,lowalpha<input id="lowalpha" value="0.1" style="width:50px;" /><br />
        <canvas id="videocanvas" style="visibility:hidden;height:0px;width:0px;"></canvas><br />
        <canvas id="videocanvas2"></canvas><canvas id="yolocanvas"></canvas><br />
        <button id="zoomin" onclick="zoom('in')">Zoom In</button>
        <button id="zoomout" onclick="zoom('out')">Zoom Out</button><br />
        <button id="screenshot-button" style="visibility:hidden;" onclick="showcropimg();">Take screenshot</button><br />
        <a id="state">模型載入中...</a><br />
        <button id="webcampredict" onclick="webcampredict2()">Predict</button><br />
    </div>
    <script>
        const captureVideoButton =
            document.querySelector('#capture-button');
        const screenshotButton = document.querySelector('#screenshot-button');
        const canvasvideo = document.querySelector('#videocanvas');
        const canvasvideo2 = document.querySelector('#videocanvas2');
        const img = document.querySelector('#screenshot-img');
        const video = document.querySelector('#streamvideo');
        var zoomsize = 1;
        function zoom(type) {
            if (type == "in") {
                if (zoomsize > 0.2) {
                    zoomsize -= 0.1;
                    screenshotButton.click();
                }
            }
            if (type == "out") {
                if (zoomsize <= 0.9) {
                    zoomsize += 0.1;
                    screenshotButton.click();
                }
            }
        }
        function initCameraStream() {
            // stop any active streams in the window
            //if (window.stream) {
            //    window.stream.getTracks().forEach(function (track) {
            //        track.stop();
            //    });
            //}
            var constraints = {
                audio: false,
                video: {
                    //width: { min: 1024, ideal: window.innerWidth, max: 1920 },
                    //height: { min: 776, ideal: window.innerHeight, max: 1080 },
                    facingMode: 'environment'
                }
            };
            navigator.mediaDevices.getUserMedia(constraints).
                then(handleSuccess).catch(handleError);
            function handleSuccess(stream) {
                window.stream = stream; // make stream available to browser console
                video.srcObject = stream;
                if (constraints.video.facingMode) {
                    return navigator.mediaDevices.enumerateDevices(); //enumerateDevices  getUserMedia
                }
            }
            function handleError(error) {
                console.log(error);
                if (error === 'PermissionDeniedError') {
                    alert("Permission denied. Please refresh and give permission.");
                }
            }
        }
        //initCameraStream();
        captureVideoButton.onclick = function () {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            var x = 0;
            var y = 0;
            var rectlen = canvas.height;
            if (canvas.width > canvas.height) {
                rectlen = canvas.height;
                x = ((canvas.width - canvas.height) / 2).toFixed(0);
            } else {
                rectlen = canvas.width;
                y = ((canvas.height - canvas.width) / 2).toFixed(0);
            }
            canvas.getContext('2d').drawImage(video, 0 + x, 0 + y, rectlen, rectlen, 0, 0, rectlen, rectlen);
            canvasvideo.width = rectlen;
            canvasvideo.height = rectlen;
            canvasvideo.getContext('2d').drawImage(canvas, 0, 0, rectlen, rectlen, 0, 0, rectlen, rectlen);
            screenshotButton.click();
        };
        //zoom
        async function showcropimg() {
            var channel = parseInt(3);
            var highalpha = parseFloat(document.getElementById("highalpha").value);
            var lowalpha = parseFloat(document.getElementById("lowalpha").value);
            const canvas = document.createElement('canvas');
            canvas.width = canvasvideo.width;
            canvas.height = canvasvideo.height;
            var x = 0;
            var y = 0;
            var rectlen = canvas.height;
            if (canvas.width > canvas.height) {
                rectlen = canvas.height;
                x = ((canvas.width - canvas.height) / 2).toFixed(0);
            } else {
                rectlen = canvas.width;
                y = ((canvas.height - canvas.width) / 2).toFixed(0);
            }
            canvas.getContext('2d').drawImage(canvasvideo, 0 + x, 0 + y, rectlen, rectlen, 0, 0, rectlen, rectlen);
            //zoomcanvas
            rectlen = 416;
            canvasvideo2.width = rectlen;
            canvasvideo2.height = rectlen;
            canvasvideo2.getContext('2d').drawImage(canvas, 0, 0);
            //await imagebalance(highalpha, lowalpha);
            canvasvideo2.getContext('2d').drawImage(canvasvideo2, (rectlen * (1 - zoomsize) / 2), (rectlen * (1 - zoomsize) / 2), rectlen * zoomsize, rectlen * zoomsize, 0, 0, rectlen, rectlen);
            var imageData = canvasvideo2.getContext('2d').getImageData(0, 0, canvas.width, canvas.height);
            if (channel == 1) {
                for (let j = 0; j < imageData.data.length / 4; j++) {
                    //Gray channel.
                    var red = imageData.data[j * 4];
                    var green = imageData.data[j * 4 + 1];
                    var blue = imageData.data[j * 4 + 2];
                    var gray = (red * 299 + green * 587 + blue * 114 + 500) / 1000;
                    if (gray < 0) gray = 0;
                    if (gray > 255) gray = 255;
                    imageData.data[j * 4] = gray;
                    imageData.data[j * 4 + 1] = gray;
                    imageData.data[j * 4 + 2] = gray;
                }
            } else {
                for (let j = 0; j < imageData.data.length / 4; j++) {
                    // All channel.
                    var red = imageData.data[j * 4];
                    var green = imageData.data[j * 4 + 1];
                    var blue = imageData.data[j * 4 + 2];
                    imageData.data[j * 4] = red;
                    imageData.data[j * 4 + 1] = green;
                    imageData.data[j * 4 + 2] = blue;
                }
            }
            canvasvideo2.getContext('2d').putImageData(imageData, 0, 0);
        };
        function imagebalance(highalpha, lowalpha) {
            var imageData = canvasvideo2.getContext('2d').getImageData(0, 0, canvasvideo2.width, canvasvideo2.height);
            var pixelArray = new Array();
            for (let j = 0; j < imageData.data.length / 4; j++) {
                for (let i = 0; i < 3; i++) {
                    pixelArray[3 * j + i] = parseInt(imageData.data[4 * j + i]);
                }
            }
            pixelArray.sort(function (a, b) {
                return a - b;
            });
            var highsearchlen = (pixelArray.length * highalpha).toFixed(0);
            var lowsearchlen = (pixelArray.length * lowalpha).toFixed(0);
            var pxAmin = 0;
            var pxAmax = 0;
            for (i = 0; i < lowsearchlen; i++) {
                pxAmin += pixelArray[i];
            }
            for (i = (pixelArray.length - highsearchlen); i < pixelArray.length; i++) {
                pxAmax += pixelArray[i];
            }
            pxAmin /= lowsearchlen;
            pxAmax /= highsearchlen;
            for (let j = 0; j < imageData.data.length / 4; j++) {
                for (let i = 0; i < 3; i++) {
                    var pixel = imageData.data[4 * j + i];
                    pixel = (pixel - pxAmin) * (255 / (pxAmax - pxAmin));
                    if (pixel < 0) pixel = 0;
                    if (pixel > 255) pixel = 255;
                    imageData.data[4 * j + i] = pixel;
                }
            }
            canvasvideo2.getContext('2d').putImageData(imageData, 0, 0);
        }
        async function webcampredict() {
            document.getElementById("state").innerHTML = "計算中...";
            //await showcropimg();
            var canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            var canvasvideo = document.getElementById('videocanvas2');
            //var boxes = await myYolo.predict(tfcrop_resize(canvasvideo));
            var boxes = await myYolo.predict(
                canvasvideo,
                {
                    maxBoxes: 5,          // defaults to 20
                    scoreThreshold: .1,   // defaults to .5
                    iouThreshold: .5,     // defaults to .3
                    numClasses: 2,       // defaults to 80 for yolo v3, tiny yolo v2, v3 and 20 for tiny yolo v1
                    anchors: v3_tiny_drug_anchors,       // v3_tiny_drug_anchors  v3_tiny_anchors
                    classNames: drug_classes,    // drug_classes  coco_classes
                    inputSize: 416,       // defaults to 416
                }
            );
            var ctx = canvas.getContext('2d');
            await ctx.drawImage(canvasvideo, 0, 0, canvasvideo.width, canvasvideo.height, 0, 0, canvas.width, canvas.height);

            //draw box to canvasvideo & crop img to yolocanvas
            for (i in Object.keys(boxes)) {
                var top = boxes[i].top;
                var left = boxes[i].left;
                var bottom = boxes[i].bottom;
                var right = boxes[i].right;
                var category = boxes[i].class;
                //if(category=="person"){break}
                //crop img to yolocanvas
                var yolocanvas = document.getElementById('yolocanvas');
                var ctx = yolocanvas.getContext('2d');
                yolocanvas.width = eval(right - left);
                yolocanvas.height = eval(bottom - top);
                await ctx.drawImage(canvasvideo, left, top, right - left, bottom - top, 0, 0, yolocanvas.width, yolocanvas.height);
                //draw box to canvasvideo
                var ctx = canvasvideo.getContext('2d');
                ctx.moveTo(left, top);
                ctx.lineTo(right, top);
                ctx.lineTo(right, bottom);
                ctx.lineTo(left, bottom);
                ctx.lineTo(left, top);
                ctx.lineWidth = 3;
                ctx.strokeStyle = "green";
                ctx.stroke();
                ctx.fillStyle = "green";
                await ctx.fillRect(left, top, category.length * 10 + 10, 25);
                ctx.fillStyle = "white";
                ctx.font = "20px Georgia";
                await ctx.fillText(category, left, top + 18);
            }
            
            preds_vector.dispose();
            document.getElementById("state").innerHTML = "完成預測";
        }
        var myYolo = "";
        async function loadmodel() {
            myYolo = await yolo.v3tiny();
            document.getElementById("state").innerHTML = "模型載入完成，開始預測!!!";
        }
        loadmodel();
    </script>
</body>
</html>